<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"> <!-- Fixed charset -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Customer Purchase Behavior Calculator</title>
    <!-- Load Poppins Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #310c7a; /* Very dark purple */
            font-family: 'Poppins', sans-serif;
        }

        /* Custom colors inspired by the new palette */
        .bg-primary-dark { background-color: #4a12bc; } /* Darker purple */
        .bg-primary-medium { background-color: #5e17eb; } /* Main purple */
        .border-primary-light { border-color: #7b42f5; } /* Lighter purple border */

        .text-accent { color: #f9af22; } /* Accent orange */
        .border-accent { border-color: #f9af22; } /* Accent orange border */
        
        .bg-chart { background-color: #f4efff; } /* Very light purple for chart BG */


        /* General styling for tables to match infographic aesthetic */
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(249, 175, 34, 0.3); /* Accent border */
        }
        th, td {
            border: 1px solid rgba(249, 175, 34, 0.2); /* Accent border */
            padding: 0.75rem;
            text-align: left;
            color: white; /* Text color for table content */
        }
        th {
            background-color: rgba(249, 175, 34, 0.1); /* Accent header */
            font-weight: 600;
        }
        td.header {
            background-color: rgba(249, 175, 34, 0.05); /* Accent row header */
            font-weight: 600;
        }
        tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.05); /* Slight stripe for readability */
        }

        /* Input field styling */
        .infographic-input {
            background-color: rgba(255, 255, 255, 0.9);
            color: #333; /* Darker text for readability */
            border: 1px solid rgba(249, 175, 34, 0.5); /* Accent border */
        }
        .infographic-input::placeholder { color: #777; }
        .infographic-input:focus {
            outline: none;
            ring: 2px;
            ring-color: #f9af22; /* Accent ring */
            border-color: #f9af22;
        }
        
        /* Styling for probability inputs */
        .prob-input {
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.375rem;
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
            border: 1px solid rgba(249, 175, 34, 0.5); /* Accent border */
            -moz-appearance: textfield; /* Firefox */
        }
        .prob-input::-webkit-outer-spin-button,
        .prob-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .prob-input:focus {
            outline: none;
            ring: 2px;
            ring-color: #f9af22; /* Fixed typo here */
            border-color: #f9af22;
        }
 
        /* Button styling */
        .infographic-button {
            background-color: #f9af22; /* Accent button */
            color: #310c7a; /* Dark purple text for contrast */
            font-weight: bold;
            transition: background-color 0.15s ease-in-out;
        }
        .infographic-button:hover { background-color: #e09d1f; } /* Darker accent */

        /* Small link-like button for header */
        .header-button {
            background-color: rgba(0, 0, 0, 0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.15s ease-in-out;
            border: 1px solid rgba(249, 175, 34, 0.3); /* Use accent color */
        }
        .header-button:hover {
            background-color: #f9af22; /* Use accent color */
            color: #310c7a; /* Use dark purple for text */
            border-color: #f9af22;
        }
    </style>
</head>
<body class="font-sans antialiased text-white">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <div class="bg-primary-medium rounded-lg shadow-xl p-6 md:p-8">
            
            <!-- Header Section with Flexbox -->
            <div class="flex justify-between items-center mb-6">
                <!-- Title (aligned left) -->
                <h1 class="text-3xl font-bold text-white">
                    Customer Purchase Behavior (HMM)
                </h1>
                
                <!-- Pop-up URL Buttons (aligned right) -->
                <div class="flex space-x-2">
                    <a href="https://pgm-sam-ise-examination.my.canva.site" target="_blank" rel="noopener noreferrer" class="header-button">
                        How it Works
                    </a>
                    <a href="https://pgm-sam-ise-examination.my.canva.site/pgm-sam-manoj-project-details-ise" target="_blank" rel="noopener noreferrer" class="header-button">
                        Project Details
                    </a>
                </div>
            </div>

            <!-- User Input Form -->
            <form method="POST" action="">
                {% csrf_token %}
                <div class="mb-8 p-6 bg-primary-dark rounded-lg border border-primary-light">
                    <h2 class="text-2xl font-semibold text-accent mb-4">Calculate for Observation Sequence:</h2>
                    <!-- Display fixed observation sequence -->
                    <p class="text-white bg-primary-medium p-3 rounded-md font-mono text-center text-lg">
                        {{ obs_sequence_names|join:" &rarr; " }}
                    </p>
                </div>

                <!-- HMM Model Parameters Input -->
                <div class="mb-8 p-6 bg-primary-dark rounded-lg border border-primary-light">
                    <h2 class="text-2xl font-semibold text-accent mb-4">HMM Model Parameters</h2>
                    
                    {% if error_message %}
                        <div class="border border-accent text-accent px-4 py-3 rounded relative mb-4" role="alert">
                            <strong class="font-bold">Warning:</strong>
                            <span class="block sm:inline">{{ error_message }}</span>
                        </div>
                    {% endif %}

                    <!-- Initial Probabilities -->
                    <h3 class="text-xl font-semibold text-white mb-2">Initial Probabilities (Ï€)</h3>
                    <table>
                        <thead>
                            <tr>
                                {% for state in states %}
                                    <th>{{ state }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                {% for prob in initial_prob %}
                                    <td>
                                        <input 
                                            type="number" 
                                            step="0.01" 
                                            min="0" 
                                            max="1" 
                                            name="pi_{{ forloop.counter0 }}" 
                                            value="{{ prob|floatformat:2 }}" 
                                            class="prob-input"
                                            required
                                        >
                                    </td>
                                {% endfor %}
                            </tr>
                        </tbody>
                    </table>

                    <!-- Transition Probabilities -->
                    <h3 class="text-xl font-semibold text-white mb-2">Transition Probabilities (From \ To)</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>&nbsp;</th>
                                {% for state in states %}
                                    <th>{{ state }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in transitions %}
                                <tr>
                                    <td class="header">{{ states.forloop.counter0 }}</td>
                                    {% for prob in row %}
                                        <td>
                                            <input 
                                                type="number" 
                                                step="0.01" 
                                                min="0" 
                                                max="1" 
                                                name="trans_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}" 
                                                value="{{ prob|floatformat:2 }}" 
                                                class="prob-input"
                                                required
                                            >
                                        </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    <!-- Emission Probabilities -->
                    <h3 class="text-xl font-semibold text-white mb-2">Emission Probabilities (State \ Observation)</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>State</th>
                                {% for obs in observations %}
                                    <th>{{ obs }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in emissions %}
                                <tr>
                                    <td class="header">{{ states.forloop.counter0 }}</td>
                                    {% for prob in row %}
                                        <td>
                                            <input 
                                                type="number" 
                                                step="0.01" 
                                                min="0" 
                                                max="1" 
                                                name="emission_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}" 
                                                value="{{ prob|floatformat:2 }}" 
                                                class="prob-input"
                                                required
                                            >
                                        </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <button 
                        type="submit"
                        class="infographic-button w-full font-bold py-2 px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2"
                    >
                        Run Algorithms
                    </button>
                </div>
            </form>
 
            <!-- Results Display -->
            <div class="mb-8 p-6 bg-primary-dark rounded-lg border border-primary-light">
                <h2 class="text-2xl font-semibold text-accent mb-4">Results</h2>
                
                <div class="mb-4">
                    <h3 class="text-lg font-medium text-white">Most Likely Hidden State Sequence (Viterbi):</h3>
                    <p class="text-lg font-semibold text-accent bg-primary-medium p-3 rounded-md font-mono">
                        {{ most_likely_states|join:" &rarr; " }}
                    </p>
                </div>
                
                <div class="mb-4">
                    <h3 class="text-lg font-medium text-white">Probability of Best Sequence (Viterbi):</h3>
                    <p class="text-lg font-semibold text-accent bg-primary-medium p-3 rounded-md font-mono">
                        {{ viterbi_prob|floatformat:"-10" }}
                    </p>
                </div>

                <div>
                    <h3 class="text-lg font-medium text-white">Total Likelihood of Sequence (Forward Algorithm):</h3>
                    <p class="text-lg font-semibold text-accent bg-primary-medium p-3 rounded-md font-mono">
                        {{ forward_prob|floatformat:"-10" }}
                    </p>
                </div>
            </div>
 
            <!-- Graph Analysis -->
            <div class="mb-8 p-6 bg-primary-dark rounded-lg border border-primary-light">
                <h2 class="text-2xl font-semibold text-accent mb-4">Graph Analysis (Viterbi Path)</h2>
                <p class="text-white text-opacity-80 mb-4">
                    This graph shows the calculated probability of the best path ending in each hidden state at each step.
                </D>
                <div class="bg-chart p-4 rounded-lg">
                    <canvas id="probabilityChart"></canvas>
                </div>
            </div>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const ctx = document.getElementById('probabilityChart').getContext('2d');
            
            // Get data from Django context
            const viterbiData = {{ viterbi_data_json|safe }};
            const labels = {{ obs_sequence_names_json|safe }};
            const states = {{ states|safe }};

            if (viterbiData && viterbiData.length > 0 && viterbiData[0].length > 0) { // Check if data is valid
                const viterbiTransposed = viterbiData[0].map((_, colIndex) => viterbiData.map(row => row[colIndex]));

                const datasets = [
                    {
                        label: states[0] || 'State 1', // Browsing
                        data: viterbiTransposed[0], // Prob of best path ending in Browsing
                        borderColor: '#36A2EB', // Blue
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        fill: true,
                        tension: 0.1
                    },
                    {
                        label: states[1] || 'State 2', // Considering
                        data: viterbiTransposed[1], // Prob of best path ending in Considering
                        borderColor: '#FFCE56', // Yellow
                        backgroundColor: 'rgba(255, 206, 86, 0.2)',
                        fill: true,
                        tension: 0.1
                    },
                    {
                        label: states[2] || 'State 3', // Buying
                        data: viterbiTransposed[2], // Prob of best path ending in Buying
                        borderColor: '#FF6384', // Red
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        fill: true,
                        tension: 0.1
                    }
                ];

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: '#333' // Chart text color
                                }
                            },
                            title: {
                                display: true,
                                text: 'Viterbi State Probabilities at Each Step',
                                color: '#333'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Probability',
                                    color: '#333'
                                },
                                ticks: {
                                    color: '#333'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Observation',
                                    color: '#333'
                                },
                                ticks: {
                                    color: '#333'
                                }
                            }
                        }
                    }
                });
            } else {
                // Optional: Display a message if no data
                const canvas = document.getElementById('probabilityChart');
                const ctxFallback = canvas.getContext('2d');
                ctxFallback.font = "16px Poppins";
                ctxFallback.fillStyle = "#888";
                ctxFallback.textAlign = "center";
                ctxFallback.fillText("Run calculation to generate graph.", canvas.width / 2, canvas.height / 2);
            }
        });
    </script>

</body>
</html>

